function getUrlVars(){for(var e,a=[],n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),t=0;t<n.length;t++)e=n[t].split("="),a.push(e[0]),a[e[0]]=e[1];return a}$(document).ready(function(){function e(e){$(".paper").html("");for(i in _.newPaperdata)_.newPaperdata[i].bpic||(_.newPaperdata[i].bpic="images/space.png"),_.newPaperdata[i].spic||(_.newPaperdata[i].spic="images/space.png"),$(".paper").append('<li><div class="newsbpic"><img src="'+_.newPaperdata[i].bpic+'"></div><div class="newsspic"><img src="'+_.newPaperdata[i].spic+'"></div><div class="newstitle">'+_.newPaperdata[i].title+'</div><div class="newsbword">'+_.newPaperdata[i].bword+'</div><div class="newssword">'+_.newPaperdata[i].sword+'</div><div class="btn"><div title="修改" class="motify"></div><div title="刪除" class="delbtn"></div></div></li>');a()}function a(){$(".paper .delbtn").click(function(){$(this).parent().find(".motify").hasClass("on")?($(this).parent().find(".motify").removeClass("on"),o(!1,$(this).parent().parent().index())):d($(this).parent().parent().index())}),$(".paper .motify").click(function(){$(this).hasClass("on")?($(this).removeClass("on"),l($(this).parent().parent().index())):($(this).addClass("on"),o(!0,$(this).parent().parent().index()))}),$(".menuin a").removeClass("on").eq(2).addClass("on"),v(!1)}function n(e){$(".paper").html("");for(i in _.newPaperdata){var a;a=_.newPaperdata[i].cover?'<img src="'+_.newPaperdata[i].cover+'">':'<img src="images/space.png">',$(".paper").eq(0).append('<li><div class="postphoto">'+a+'</div><div class="posttitle">'+_.newPaperdata[i].title+'</div><div class="postdes">'+_.newPaperdata[i].info+'</div><div class="postid">　</div><div class="btn"><div title="修改" class="motify"></div></div></li>')}for(i in _.newPaperdata[0].list){var a;a=_.newPaperdata[0].list[i].pic?'<img src="'+_.newPaperdata[0].list[i].pic+'">':'<img src="images/space.png">',$(".paper").eq(1).append('<li><div class="postphoto">'+a+'</div><div class="posttitle">'+_.newPaperdata[0].list[i].name+'</div><div class="postdes">'+_.newPaperdata[0].list[i].des+'</div><div class="postid">　</div><div class="btn"><div title="修改" class="motify"></div><div title="刪除" class="delbtn"></div></div></li>')}t()}function t(){$(".paper .delbtn").click(function(){$(this).parent().find(".motify").hasClass("on")?($(this).parent().find(".motify").removeClass("on"),o(!1,$(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))):d($(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))}),$(".paper .motify").click(function(){$(this).hasClass("on")?($(this).removeClass("on"),l($(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))):($(this).addClass("on"),o(!0,$(this).parent().parent().index(),$(this).parent().parent().parent().attr("num")))}),$(".menuin a").removeClass("on").eq(1).addClass("on"),v(!1)}function s(e){window.location.href=e.attr("gopage")+"#access_token="+window.location.href.split("#access_token=")[1]}function p(){$.cookie("useraccount",""),$.cookie("userpassword",""),window.location.href="index.html"}function r(){var e=!1;return $.cookie("useraccount")&&$.cookie("userpassword")&&(e=!0),e}function o(e,a,n){if(_.wrp.hasClass("about")){var t=$(".paper").eq(n).find("li").eq(a);e?(t.find(".posttitle").html("<textarea>"+t.find(".posttitle").html().replace(/<br>/g,"\n")+"</textarea>"),t.find(".postdes").html("<textarea>"+t.find(".postdes").html().replace(/<br>/g,"\n")+"</textarea>"),t.find(".postphoto").prepend('<input type="file" name="file" id="imgInputMotify" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify"><span>點擊更換</span></label>'),$("#imgInputMotify").change(function(){w(this,$(this))})):(t.find(".posttitle").html(t.find(".posttitle textarea").val().replace(/\n\r?/g,"<br>")),t.find(".postdes").html(t.find(".postdes textarea").val().replace(/\n\r?/g,"<br>")),t.find(".postphoto").html('<img src="'+_.newPaperdata[0].list[a].pic+'">'))}else if(_.wrp.hasClass("news")){var t=$(".paper").find("li").eq(a);e?(t.find(".newstitle").html("<textarea>"+t.find(".newstitle").html().replace(/<br>/g,"\n")+"</textarea>"),t.find(".newsbword").html("<textarea>"+t.find(".newsbword").html().replace(/<br>/g,"\n")+"</textarea>"),t.find(".newssword").html("<textarea>"+t.find(".newssword").html().replace(/<br>/g,"\n")+"</textarea>"),t.find(".newsbpic").prepend('<input type="file" name="file" id="imgInputMotify" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify"><span>點擊更換</span></label>'),$("#imgInputMotify").change(function(){w(this,$(this),0)}),t.find(".newsspic").prepend('<input type="file" name="file" id="imgInputMotify2" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify2"><span>點擊更換</span></label>'),$("#imgInputMotify2").change(function(){w(this,$(this),1)})):(t.find(".newstitle").html(t.find(".newstitle textarea").val().replace(/\n\r?/g,"<br>")),t.find(".newsbword").html(t.find(".newsbword textarea").val().replace(/\n\r?/g,"<br>")),t.find(".newssword").html(t.find(".newssword textarea").val().replace(/\n\r?/g,"<br>")),t.find(".newsbpic").html('<img src="'+_.newPaperdata[a].bpic+'">'),t.find(".newsspic").html('<img src="'+_.newPaperdata[a].spic+'">'))}}function l(e,a){v(!0),_.wrp.hasClass("about")?(_._n=e,_._num=a,$(".paper").eq(a).find("li").eq(e).find(".postphoto").find("img").hasClass("on")?g(_.uploadImg,c):(_.uploadImgTrue=$(".paper").eq(a).find("li").eq(e).find(".postphoto").find("img").attr("src"),c())):_.wrp.hasClass("news")&&(_._n=e,_.newspiccheck=0,$(".paper").find("li").eq(e).find(".newsbpic").find("img").hasClass("on")?g(_.uploadImgbpic,c,0):(_.newspiccheck+=1,_.uploadImgbpic=$(".paper").find("li").eq(e).find(".newsbpic").find("img").attr("src")),$(".paper").find("li").eq(e).find(".newsspic").find("img").hasClass("on")?g(_.uploadImgspic,c,1):(_.newspiccheck+=1,_.uploadImgspic=$(".paper").find("li").eq(e).find(".newsspic").find("img").attr("src")),c())}function c(){if(_.wrp.hasClass("about"))0==_._num?(_.newPaperdata[0].title=$(".paper").eq(_._num).find("li").eq(_._n).find(".posttitle").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[0].info=$(".paper").eq(_._num).find("li").eq(_._n).find(".postdes").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[0].cover=_.uploadImgTrue):1==_._num&&(_.newPaperdata[0].list[_._n].name=$(".paper").eq(_._num).find("li").eq(_._n).find(".posttitle").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[0].list[_._n].des=$(".paper").eq(_._num).find("li").eq(_._n).find(".postdes").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[0].list[_._n].pic=_.uploadImgTrue),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+_.nowpage+"?apiKey="+_.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(_.newPaperdata),success:function(e){y("aboutus_page",n)},error:function(e,a,n){console.log("error:",e,a,n)}});else if(_.wrp.hasClass("news")){if(_.newspiccheck<2)return;_.newPaperdata[_._n].title=$(".paper").find("li").eq(_._n).find(".newstitle").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[_._n].spic=_.uploadImgspic,_.newPaperdata[_._n].bpic=_.uploadImgbpic,_.newPaperdata[_._n].date=new Date,_.newPaperdata[_._n].sword=$(".paper").find("li").eq(_._n).find(".newssword").find("textarea").val().replace(/\n\r?/g,"<br>"),_.newPaperdata[_._n].bword=$(".paper").find("li").eq(_._n).find(".newsbword").find("textarea").val().replace(/\n\r?/g,"<br>"),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/news_page"+_.nowpage+"/"+_.newPaperdata[_._n]._id.$oid+"?apiKey="+_.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(_.newPaperdata[_._n]),success:function(a){y("news_page",e)},error:function(e,a,n){console.log("error:",e,a,n)}})}}function d(a,t){v(!0),_.wrp.hasClass("about")?(_.newPaperdata[0].list.splice(a,a),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+_.nowpage+"?apiKey="+_.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(_.newPaperdata),success:function(e){y("aboutus_page",n)},error:function(e,a,n){console.log("error:",e,a,n)}})):_.wrp.hasClass("news")&&$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/news_page"+_.nowpage+"/"+_.newPaperdata[a]._id.$oid+"?apiKey="+_.mlabApikey,type:"DELETE",async:!0,timeout:3e5,contentType:"application/json",success:function(a){y("news_page",e)},error:function(e,a,n){console.log("error:",e,a,n)}})}function u(e,a,n){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){0==n?_.newsuploadImgbpic=e.target.result.replace(/.*,/,""):_.newsuploadImgspic=e.target.result.replace(/.*,/,""),a.parent().addClass("on").find("img").addClass("on").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function w(e,a,n){if(_.wrp.hasClass("about")){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){_.uploadImg=e.target.result.replace(/.*,/,""),a.parent().addClass("on").find("img").addClass("on").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}else if(_.wrp.hasClass("news")&&e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){0==n?_.uploadImgbpic=e.target.result.replace(/.*,/,""):_.uploadImgspic=e.target.result.replace(/.*,/,""),a.parent().addClass("on").find("img").addClass("on").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function f(){if(_.wrp.hasClass("about")){if(_.posttitleval=$(".new .posttitle").val(),_.postdesval=$(".new .postdes").val(),!_.posttitleval||!_.postdesval)return void alert(_.creatUsererrortxt);v(!0),_.uploadImg?g(_.uploadImg,h):h()}else if(_.wrp.hasClass("news")){if(_.insertdata={title:$(".new .newstitle").val().replace(/\n\r?/g,"<br>"),date:new Date,sword:$(".new .newssword").val().replace(/\n\r?/g,"<br>"),bword:$(".new .newsbword").val().replace(/\n\r?/g,"<br>")},!_.insertdata.title||!_.insertdata.sword||!_.insertdata.bword)return void alert(_.creatUsererrortxt);v(!0),_.newsinsertpiccheck=0,_.newsuploadImgbpic?m(_.newsuploadImgbpic,h,0):(_.newsinsertpiccheck+=1,_.newsuploadImgbpic="images/space.png"),_.newsuploadImgspic?m(_.newsuploadImgspic,h,1):(_.newsinsertpiccheck+=1,_.newsuploadImgspic="images/space.png"),h()}}function m(e,a,n){$.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Bearer "+_.imgurToken,Accept:"application/json"},data:{image:e,type:"base64"},success:function(e){_.wrp.hasClass("news")&&(_.newsinsertpiccheck+=1,0==n?_.newsuploadImgbpic=e.data.link:_.newsuploadImgspic=e.data.link),a()},error:function(e,a,n){console.log("error:",e,a,n),window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+_.imgurappid}})}function g(e,a,n){$.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Bearer "+_.imgurToken,Accept:"application/json"},data:{image:e,type:"base64"},success:function(e){_.wrp.hasClass("about")&&(_.uploadImgTrue=e.data.link),_.wrp.hasClass("news")&&(_.newspiccheck+=1,0==n?_.uploadImgbpic=e.data.link:_.uploadImgspic=e.data.link),a()},error:function(e,a,n){console.log("error:",e,a,n),window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+_.imgurappid}})}function h(){if(_.wrp.hasClass("about"))_.newPaperdata[0].list.push({name:_.posttitleval.replace(/\n\r?/g,"<br>"),des:_.postdesval.replace(/\n\r?/g,"<br>"),pic:_.uploadImgTrue}),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+_.nowpage+"?apiKey="+_.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(_.newPaperdata),success:function(e){b(),y("aboutus_page",n)},error:function(e,a,n){console.log("error:",e,a,n)}});else if(_.wrp.hasClass("news")){if(_.newsinsertpiccheck<2)return;_.insertdata.bpic=_.newsuploadImgbpic,_.insertdata.spic=_.newsuploadImgspic,$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/news_page"+_.nowpage+"?apiKey="+_.mlabApikey,type:"POST",contentType:"application/json",data:JSON.stringify(_.insertdata),success:function(e){location.reload()},error:function(e,a,n){console.log("error:",e,a,n)}})}}function b(){_.posttitleval="",_.nowtime="",_.postdesval="",_.uploadImg="",_.uploadImgTrue="",$(".new .posttitle").val(""),$(".new .postdes").val(""),$(".new .addImg").removeClass("on").find("img").attr("src","")}function v(e){e?$(".loading").fadeIn():($(".loading").hasClass("on")||$(".loading").addClass("on"),$(".loading").fadeOut())}function y(e,a){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/"+e+_.nowpage+"?apiKey="+_.mlabApikey,type:"GET",contentType:"application/json",success:function(e){_.newPaperdata=e,a(e)},error:function(e,a,n){console.log("error:",e,a,n)}})}var _={};_.wrp=$(".wrapper"),_.mlabApikey="n6FXodWWCdM14KrePZHrRPPovbzboRn6",_.imgurappid="752b0363900112d",_.creatUsererrortxt="請填寫完整資料";try{_.nowpage=getUrlVars().page.replace("#access_token","")}catch(P){_.nowpage=1}$(".sec_menu").length>0&&$(".sec_menu a").eq(_.nowpage-1).addClass("on"),$(".title").eq(0).html($(".sec_menu a").eq(_.nowpage-1).text()),_.wrp.hasClass("about")?y("aboutus_page",n):_.wrp.hasClass("news")?y("news_page",e):v(!1),$(".menua").click(function(){s($(this))}),$("#imgInput").change(function(){w(this,$(this))}),$("#newsimgInput").change(function(){u(this,$(this),0)}),$("#newsimgInput2").change(function(){u(this,$(this),1)}),$(".userMenu .logoutbtn").click(function(){p()}),$(".new .gobtn").click(function(){f()}),$(window).load(function(){if(r())try{_.imgurToken=window.location.href.split("#")[1].split("&")[0].replace("access_token=",""),$(".userMenu .icon").html($.cookie("useraccount").substring(0,1)),$(".userMenu .name").html($.cookie("username"))}catch(e){window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+_.imgurappid}else window.location.href="index.html"+window.location.hash})});