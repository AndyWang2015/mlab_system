$(document).ready(function(){function t(){$.cookie("useraccount",""),$.cookie("userpassword",""),window.location.href="index.html"}function e(){var t=!1;return $.cookie("useraccount")&&$.cookie("userpassword")&&(t=!0),t}function a(t){m(!0),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid/"+h.newPaperdata[t]._id.$oid+"?apiKey="+h.mlabApikey,type:"DELETE",async:!0,timeout:3e5,contentType:"application/json",success:function(t){p()},error:function(t,e,a){console.log("error:",t,e,a)}})}function o(t){$(".paper li").eq(t).find(".posttitle").html("<textarea>"+$(".paper li").eq(t).find(".posttitle").text()+"</textarea>"),$(".paper li").eq(t).find(".postdes").html("<textarea>"+$(".paper li").eq(t).find(".postdes").text()+"</textarea>"),$(".paper li").eq(t).find(".postphoto").prepend('<input type="file" name="file" id="imgInputMotify" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify"><span>點擊更換</span></label>'),$("#imgInputMotify").change(function(){l(this,$(this))})}function n(t){h.nowmotifyPaperEnd=t,m(!0),$(".paper li").eq(t).find(".postphoto").find("img").hasClass("on")?c(h.uploadImg,s):(h.uploadImgTrue=$(".paper li").eq(t).find(".postphoto").find("img").attr("src"),s())}function s(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid/"+h.newPaperdata[h.nowmotifyPaperEnd]._id.$oid+"?apiKey="+h.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify({postdate:new Date,postdes:$(".paper li").eq(h.nowmotifyPaperEnd).find(".postdes").find("textarea").val(),postid:h.newPaperdata[h.nowmotifyPaperEnd].postid,posttitle:$(".paper li").eq(h.nowmotifyPaperEnd).find(".posttitle").find("textarea").val(),postphoto:h.uploadImgTrue}),success:function(t){p()},error:function(t,e,a){console.log("error:",t,e,a)}})}function p(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid?apiKey="+h.mlabApikey,type:"GET",contentType:"application/json",success:function(t){h.newPaperdata=t,d()},error:function(t,e,a){console.log("error:",t,e,a)}})}function d(){$(".paper").html("");for(i in h.newPaperdata){var t;t=h.newPaperdata[i].postphoto?'<img src="'+h.newPaperdata[i].postphoto+'">':'<img src="http://bizdev.medialand.com.tw/andy/mongoDB_mLab/images/space.png">',$(".paper").append('<li><div class="postphoto">'+t+'</div><div class="posttitle">'+h.newPaperdata[i].posttitle+'</div><div class="postdes">'+h.newPaperdata[i].postdes+'</div><div class="postid">'+h.newPaperdata[i].postdate+'</div><div class="btn"><div class="motify"></div><div class="delbtn"></div></div></li>')}$(".paper .delbtn").click(function(){a($(this).parent().parent().index())}),$(".paper .motify").click(function(){$(this).hasClass("on")?($(this).removeClass("on"),n($(this).parent().parent().index())):($(this).addClass("on"),o($(this).parent().parent().index()))}),m(!1)}function l(t,e){if(t.files&&t.files[0]){var a=new FileReader;a.onload=function(t){h.uploadImg=t.target.result.replace(/.*,/,""),e.parent().addClass("on").find("img").addClass("on").attr("src",t.target.result)},a.readAsDataURL(t.files[0])}}function r(){return h.nowtime=new Date,h.posttitleval=$(".new .posttitle").val(),h.postdesval=$(".new .postdes").val(),h.posttitleval&&h.nowtime&&h.postdesval?(m(!0),void(h.uploadImg?c(h.uploadImg,u):u())):void alert("請填寫資料內容")}function c(t,e){$.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Bearer dda8820b12e7a3d7f46fad118484a2da0d3f72a5",Accept:"application/json"},data:{image:t,type:"base64"},success:function(t){h.uploadImgTrue=t.data.link,e()}})}function u(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid?apiKey="+h.mlabApikey,type:"POST",contentType:"application/json",data:JSON.stringify({postdate:h.nowtime,postdes:h.postdesval,postid:"0000",posttitle:h.posttitleval,postphoto:h.uploadImgTrue}),success:function(t){f(),p()},error:function(t,e,a){console.log("error:",t,e,a)}})}function f(){h.posttitleval="",h.nowtime="",h.postdesval="",h.uploadImg="",h.uploadImgTrue="",$(".new .posttitle").val(""),$(".new .postdes").val(""),$(".new .addImg").removeClass("on").find("img").attr("src","")}function m(t){t?$(".loading").fadeIn():($(".loading").hasClass("on")||$(".loading").addClass("on"),$(".loading").fadeOut())}var h={};h.mlabApikey="n6FXodWWCdM14KrePZHrRPPovbzboRn6",h.creatUsererrortxt="請填寫完整資料",$("#imgInput").change(function(){l(this,$(this))}),$(".userMenu .logoutbtn").click(function(){t()}),$(".andy_test .new .gobtn").click(function(){r()}),$(window).load(function(){e()?($(".userMenu .icon").html($.cookie("useraccount").substring(0,1)),$(".userMenu .name").html($.cookie("username")),p()):window.location.href="index.html"+window.location.hash})});