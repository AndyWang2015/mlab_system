$(document).ready(function(){function e(){$.cookie("useraccount",""),$.cookie("userpassword",""),window.location.href="index.html"}function t(){var e=!1;return $.cookie("useraccount")&&$.cookie("userpassword")&&(e=!0),e}function a(e){f(!0),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid/"+h.newPaperdata[e]._id.$oid+"?apiKey="+h.mlabApikey,type:"DELETE",async:!0,timeout:3e5,contentType:"application/json",success:function(e){p()},error:function(e,t,a){console.log("error:",e,t,a)}})}function o(e){$(".paper li").eq(e).find(".posttitle").html("<textarea>"+$(".paper li").eq(e).find(".posttitle").text()+"</textarea>"),$(".paper li").eq(e).find(".postdes").html("<textarea>"+$(".paper li").eq(e).find(".postdes").text()+"</textarea>"),$(".paper li").eq(e).find(".postphoto").prepend('<input type="file" name="file" id="imgInputMotify" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify"><span>點擊更換</span></label>'),$("#imgInputMotify").change(function(){l(this,$(this))})}function n(e){h.nowmotifyPaperEnd=e,f(!0),$(".paper li").eq(e).find(".postphoto").find("img").hasClass("on")?c(h.uploadImg,s):(h.uploadImgTrue=$(".paper li").eq(e).find(".postphoto").find("img").attr("src"),s())}function s(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid/"+h.newPaperdata[h.nowmotifyPaperEnd]._id.$oid+"?apiKey="+h.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify({postdate:new Date,postdes:$(".paper li").eq(h.nowmotifyPaperEnd).find(".postdes").find("textarea").val(),postid:h.newPaperdata[h.nowmotifyPaperEnd].postid,posttitle:$(".paper li").eq(h.nowmotifyPaperEnd).find(".posttitle").find("textarea").val(),postphoto:h.uploadImgTrue}),success:function(e){p()},error:function(e,t,a){console.log("error:",e,t,a)}})}function p(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid?apiKey="+h.mlabApikey,type:"GET",contentType:"application/json",success:function(e){h.newPaperdata=e,r()},error:function(e,t,a){console.log("error:",e,t,a)}})}function r(){$(".paper").html("");for(i in h.newPaperdata){var e;e=h.newPaperdata[i].postphoto?'<img src="'+h.newPaperdata[i].postphoto+'">':'<img src="http://bizdev.medialand.com.tw/andy/mongoDB_mLab/images/space.png">',$(".paper").append('<li><div class="postphoto">'+e+'</div><div class="posttitle">'+h.newPaperdata[i].posttitle+'</div><div class="postdes">'+h.newPaperdata[i].postdes+'</div><div class="postid">'+h.newPaperdata[i].postdate+'</div><div class="btn"><div class="motify"></div><div class="delbtn"></div></div></li>')}$(".paper .delbtn").click(function(){a($(this).parent().parent().index())}),$(".paper .motify").click(function(){$(this).hasClass("on")?($(this).removeClass("on"),n($(this).parent().parent().index())):($(this).addClass("on"),o($(this).parent().parent().index()))}),f(!1)}function l(e,t){if(e.files&&e.files[0]){var a=new FileReader;a.onload=function(e){h.uploadImg=e.target.result.replace(/.*,/,""),t.parent().addClass("on").find("img").addClass("on").attr("src",e.target.result)},a.readAsDataURL(e.files[0])}}function d(){return h.nowtime=new Date,h.posttitleval=$(".new .posttitle").val(),h.postdesval=$(".new .postdes").val(),h.posttitleval&&h.nowtime&&h.postdesval?(f(!0),void(h.uploadImg?c(h.uploadImg,u):u())):void alert("請填寫資料內容")}function c(e,t){$.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Bearer "+h.imgurToken,Accept:"application/json"},data:{image:e,type:"base64"},success:function(e){h.uploadImgTrue=e.data.link,t()},error:function(e,t,a){console.log("error:",e,t,a),window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+h.imgurappid}})}function u(){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/paperid?apiKey="+h.mlabApikey,type:"POST",contentType:"application/json",data:JSON.stringify({postdate:h.nowtime,postdes:h.postdesval,postid:"0000",posttitle:h.posttitleval,postphoto:h.uploadImgTrue}),success:function(e){m(),p()},error:function(e,t,a){console.log("error:",e,t,a)}})}function m(){h.posttitleval="",h.nowtime="",h.postdesval="",h.uploadImg="",h.uploadImgTrue="",$(".new .posttitle").val(""),$(".new .postdes").val(""),$(".new .addImg").removeClass("on").find("img").attr("src","")}function f(e){e?$(".loading").fadeIn():($(".loading").hasClass("on")||$(".loading").addClass("on"),$(".loading").fadeOut())}var h={};h.mlabApikey="n6FXodWWCdM14KrePZHrRPPovbzboRn6",h.imgurappid="752b0363900112d",h.creatUsererrortxt="請填寫完整資料",$("#imgInput").change(function(){l(this,$(this))}),$(".userMenu .logoutbtn").click(function(){e()}),$(".andy_test .new .gobtn").click(function(){d()}),$(window).load(function(){if(t())try{h.imgurToken=window.location.href.split("#")[1].split("&")[0].replace("access_token=",""),$(".userMenu .icon").html($.cookie("useraccount").substring(0,1)),$(".userMenu .name").html($.cookie("username")),p()}catch(e){window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+h.imgurappid}else window.location.href="index.html"+window.location.hash})});