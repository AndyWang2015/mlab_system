function getUrlVars(){for(var e,a=[],t=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),n=0;n<t.length;n++)e=t[n].split("="),a.push(e[0]),a[e[0]]=e[1];return a}$(document).ready(function(){function e(e){$(".paper").html("");for(i in w.newPaperdata){var t;t=w.newPaperdata[i].cover?'<img src="'+w.newPaperdata[i].cover+'">':'<img src="images/space.png">',$(".paper").eq(0).append('<li><div class="postphoto">'+t+'</div><div class="posttitle">'+w.newPaperdata[i].title+'</div><div class="postdes">'+w.newPaperdata[i].info+'</div><div class="postid">　</div><div class="btn"><div class="motify"></div></div></li>')}for(i in w.newPaperdata[0].list){var t;t=w.newPaperdata[0].list[i].pic?'<img src="'+w.newPaperdata[0].list[i].pic+'">':'<img src="images/space.png">',$(".paper").eq(1).append('<li><div class="postphoto">'+t+'</div><div class="posttitle">'+w.newPaperdata[0].list[i].name+'</div><div class="postdes">'+w.newPaperdata[0].list[i].des+'</div><div class="postid">　</div><div class="btn"><div class="motify"></div><div class="delbtn"></div></div></li>')}a()}function a(){$(".paper .delbtn").click(function(){$(this).parent().find(".motify").hasClass("on")?($(this).parent().find(".motify").removeClass("on"),p(!1,$(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))):s($(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))}),$(".paper .motify").click(function(){$(this).hasClass("on")?($(this).removeClass("on"),r($(this).parent().parent().index(),$(this).parent().parent().parent().attr("num"))):($(this).addClass("on"),p(!0,$(this).parent().parent().index(),$(this).parent().parent().parent().attr("num")))}),$(".sec_menu").length>0&&$(".sec_menu a").eq(w.nowpage-1).addClass("on"),g(!1)}function t(e){window.location.href=e.attr("gopage")+"#access_token="+window.location.href.split("#access_token=")[1]}function n(){$.cookie("useraccount",""),$.cookie("userpassword",""),window.location.href="index.html"}function o(){var e=!1;return $.cookie("useraccount")&&$.cookie("userpassword")&&(e=!0),e}function s(a,t){g(!0),w.newPaperdata[0].list.splice(a,a),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+w.nowpage+"?apiKey="+w.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(w.newPaperdata),success:function(a){h("aboutus_page",e)},error:function(e,a,t){console.log("error:",e,a,t)}})}function p(e,a,t){var n=$(".paper").eq(t).find("li").eq(a);e?(n.find(".posttitle").html("<textarea>"+n.find(".posttitle").html().replace(/<br>/g,"\n")+"</textarea>"),n.find(".postdes").html("<textarea>"+n.find(".postdes").html().replace(/<br>/g,"\n")+"</textarea>"),n.find(".postphoto").prepend('<input type="file" name="file" id="imgInputMotify" accept="image/*" capture="camera"><label class="imgInputlabel" for="imgInputMotify"><span>點擊更換</span></label>'),$("#imgInputMotify").change(function(){c(this,$(this))})):(n.find(".posttitle").html(n.find(".posttitle textarea").val().replace(/\n\r?/g,"<br>")),n.find(".postdes").html(n.find(".postdes textarea").val().replace(/\n\r?/g,"<br>")),n.find(".postphoto").html('<img src="'+w.newPaperdata[0].list[a].pic+'">'))}function r(e,a){g(!0),w._n=e,w._num=a,$(".paper").eq(a).find("li").eq(e).find(".postphoto").find("img").hasClass("on")?u(w.uploadImg,l):(w.uploadImgTrue=$(".paper").eq(a).find("li").eq(e).find(".postphoto").find("img").attr("src"),l())}function l(){0==w._num?(w.newPaperdata[0].title=$(".paper").eq(w._num).find("li").eq(w._n).find(".posttitle").find("textarea").val().replace(/\n\r?/g,"<br>"),w.newPaperdata[0].info=$(".paper").eq(w._num).find("li").eq(w._n).find(".postdes").find("textarea").val().replace(/\n\r?/g,"<br>"),w.newPaperdata[0].cover=w.uploadImgTrue):1==w._num&&(w.newPaperdata[0].list[w._n].name=$(".paper").eq(w._num).find("li").eq(w._n).find(".posttitle").find("textarea").val().replace(/\n\r?/g,"<br>"),w.newPaperdata[0].list[w._n].des=$(".paper").eq(w._num).find("li").eq(w._n).find(".postdes").find("textarea").val().replace(/\n\r?/g,"<br>"),w.newPaperdata[0].list[w._n].pic=w.uploadImgTrue),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+w.nowpage+"?apiKey="+w.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(w.newPaperdata),success:function(a){h("aboutus_page",e)},error:function(e,a,t){console.log("error:",e,a,t)}})}function c(e,a){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){w.uploadImg=e.target.result.replace(/.*,/,""),a.parent().addClass("on").find("img").addClass("on").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}function d(){return w.posttitleval=$(".new .posttitle").val(),w.postdesval=$(".new .postdes").val(),w.posttitleval&&w.postdesval?(g(!0),void(w.uploadImg?u(w.uploadImg,f):f())):void alert("請填寫資料內容")}function u(e,a){$.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Bearer "+w.imgurToken,Accept:"application/json"},data:{image:e,type:"base64"},success:function(e){w.uploadImgTrue=e.data.link,a()},error:function(e,a,t){console.log("error:",e,a,t),window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+w.imgurappid}})}function f(){w.newPaperdata[0].list.push({name:w.posttitleval.replace(/\n\r?/g,"<br>"),des:w.postdesval.replace(/\n\r?/g,"<br>"),pic:w.uploadImgTrue}),$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/aboutus_page"+w.nowpage+"?apiKey="+w.mlabApikey,type:"PUT",contentType:"application/json",data:JSON.stringify(w.newPaperdata),success:function(a){m(),h("aboutus_page",e)},error:function(e,a,t){console.log("error:",e,a,t)}})}function m(){w.posttitleval="",w.nowtime="",w.postdesval="",w.uploadImg="",w.uploadImgTrue="",$(".new .posttitle").val(""),$(".new .postdes").val(""),$(".new .addImg").removeClass("on").find("img").attr("src","")}function g(e){e?$(".loading").fadeIn():($(".loading").hasClass("on")||$(".loading").addClass("on"),$(".loading").fadeOut())}function h(e,a){$.ajax({url:"https://api.mlab.com/api/1/databases/chinesechess2016/collections/"+e+w.nowpage+"?apiKey="+w.mlabApikey,type:"GET",contentType:"application/json",success:function(e){w.newPaperdata=e,a(e)},error:function(e,a,t){console.log("error:",e,a,t)}})}var w={};w.wrp=$(".wrapper"),w.mlabApikey="n6FXodWWCdM14KrePZHrRPPovbzboRn6",w.imgurappid="752b0363900112d",w.creatUsererrortxt="請填寫完整資料";try{w.nowpage=getUrlVars().page.replace("#access_token","")}catch(v){w.nowpage=getUrlVars().page}w.wrp.hasClass("about")?h("aboutus_page",e):g(!1),$(".menua").click(function(){t($(this))}),$("#imgInput").change(function(){c(this,$(this))}),$(".userMenu .logoutbtn").click(function(){n()}),$(".new .gobtn").click(function(){d()}),$(window).load(function(){if(o())try{w.imgurToken=window.location.href.split("#")[1].split("&")[0].replace("access_token=",""),$(".userMenu .icon").html($.cookie("useraccount").substring(0,1)),$(".userMenu .name").html($.cookie("username"))}catch(e){window.location.href="https://api.imgur.com/oauth2/authorize?response_type=token&client_id="+w.imgurappid}else window.location.href="index.html"+window.location.hash})});